<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weight360</title>

  <!-- Icons / theme (favicon is inline SVG so you don't need extra files) -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256"><rect width="100%" height="100%" rx="48" ry="48" fill="%230f1724"/><text x="50%" y="56%" dominant-baseline="middle" text-anchor="middle" font-family="Inter,Arial,sans-serif" font-size="98" font-weight="700" fill="%23f472b6">W360</text></svg>' type="image/svg+xml">
  <meta name="theme-color" content="#0f1724">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>

  <style>
    :root{
      --bg:#0f1724;--card:#0b1220;--accent:#60a5fa;--muted:#94a3b8;--gold:#ffd166;--pink:#f472b6;color-scheme:dark
    }
    html,body{
      margin:0;background:linear-gradient(180deg,#071026 0%, #071827 100%);color:#e6eef8;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial
    }
    .wrap{max-width:980px;margin:16px auto;padding:0 14px}
    header.hero{
      display:flex;flex-direction:column;gap:12px;margin-bottom:16px;padding:18px 20px;border-radius:16px;
      background:linear-gradient(135deg, rgba(255,95,162,0.18), rgba(96,165,250,0.12));
      border:1px solid rgba(255,95,162,0.35);box-shadow:0 10px 30px rgba(2,6,23,0.45)
    }
    h1{font-size:1.4rem;margin:0;color:var(--pink)}
    .tiny{font-size:.9rem}.muted{color:var(--muted)}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;padding:0;margin-bottom:14px;box-shadow:0 6px 20px rgba(2,6,23,0.6);border:1px solid var(--pink)
    }
    .card summary{cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:14px;font-size:1rem;color:var(--pink)}
    .card summary::after{content:"▶";color:var(--pink);transition:transform .3s}
    .card[open] summary::after{transform:rotate(90deg)}
    .card .content{padding:0 14px 14px}
    input,button{
      padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);
      background:transparent;color:inherit;min-height:34px;font-size:.9rem
    }
    input[type="date"]{min-width:120px}
    button{cursor:pointer}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 200px}
    .right{margin-left:auto}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.06)}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.06);font-size:.95rem}
    td.actions{text-align:right;white-space:nowrap}
    .bar{height:12px;border-radius:8px;background:#1f2a44;overflow:hidden}
    .bar>span{display:block;height:100%;background:var(--gold);width:0%}

    /* CHART */
    #chartWrap { position: relative; height: 320px; width: 100%; }
    #weightChart { position: absolute; inset: 0; width: 100% !important; height: 100% !important; display: block; }
    .chart-row{display:flex;gap:12px;align-items:flex-start}
    .stats{flex:1 1 35%;display:flex;flex-direction:column;gap:8px}
    .stat{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
    @media(max-width:780px){.chart-row{flex-direction:column}}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:20px;flex-wrap:wrap">
        <div>
          <h1>Weight360</h1>
          <div class="tiny muted">Private weight & calorie tracker — saved locally on this device</div>
          <div class="tiny muted" style="margin-top:6px">Target date: <b id="targetDateLbl">Jan 1, 2026</b></div>
          <div class="row" style="margin-top:8px">
            <input id="nameInput" placeholder="Your name" style="width:160px">
            <button id="saveName" type="button">Set</button>
            <button id="clearName" type="button">Clear</button>
            <span class="pill tiny">Hi, <b id="nameDisplay">—</b></span>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
          <div class="row" style="gap:6px">
            <input type="number" step="0.1" id="quickWeight" placeholder="Weight" style="width:100px">
            <button id="quickWeightBtn" type="button">Add</button>
          </div>
          <div class="row" style="gap:6px">
            <input type="number" id="quickCalories" placeholder="Calories" style="width:100px">
            <button id="quickCaloriesBtn" type="button">Add</button>
          </div>
          <div class="row" style="gap:6px">
            <input type="number" id="quickWater" placeholder="Water (cups)" style="width:110px">
            <button id="quickWaterBtn" type="button">Add</button>
          </div>
        </div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:20px;margin-top:10px">
        <div class="bar" style="flex:1"><span id="headerProgressBar"></span></div>
        <div class="tiny muted">Current: <b id="currentWeightLbl">—</b></div>
        <div class="tiny muted" id="headerProgressLabel">0%</div>
      </div>
    </header>

    <!-- WEIGHT TRACKER -->
    <details class="card" open>
      <summary>Weight Tracker</summary>
      <div class="content">
        <div class="row">
          <div class="grow">
            <label class="tiny muted">Date</label><br/>
            <input type="date" id="date">
          </div>
          <div>
            <label class="tiny muted">Weight (lbs)</label><br/>
            <input type="number" step="0.1" id="weight" placeholder="e.g. 238.6">
          </div>
          <div class="grow">
            <label class="tiny muted">Notes</label><br/>
            <input type="text" id="notes" placeholder="morning weigh-in, gym, etc.">
          </div>
          <div>
            <button id="addWeight" type="button">Add</button>
            <button id="saveWeight" type="button" style="display:none">Save</button>
          </div>
        </div>
        <div class="row" style="margin-top:10px;align-items:center;gap:8px">
          <label class="tiny muted">Goal (lbs)</label>
          <input type="number" step="0.1" id="goal" placeholder="190" style="width:120px">
          <button id="saveGoal" type="button">Set</button>
          <button id="clearGoal" type="button" title="Clear saved goal">Clear</button>
          <span class="pill tiny">Current goal: <b id="hdrGoal">—</b></span>
        </div>
      </div>
    </details>

    <!-- FOOD & CALORIES -->
    <details class="card">
      <summary>Food & Calories</summary>
      <div class="content">
        <div class="row">
          <div><label class="tiny muted">Date</label><br/><input type="date" id="foodDate"></div>
          <div class="grow"><label class="tiny muted">Food</label><br/><input id="foodName" placeholder="eggs & toast"></div>
          <div><label class="tiny muted">Calories</label><br/><input type="number" id="foodCals" placeholder="320"></div>
          <div><button id="addFood" type="button">Add food</button></div>
          <div class="right">
            <label class="tiny muted">Maintenance kcal/day</label><br/>
            <input type="number" id="maintKcal" placeholder="auto" style="width:160px">
            <button id="autoMaint" type="button" title="Rough estimate: 12 × current weight">Auto</button>
          </div>
        </div>
        <div class="row tiny" style="margin-top:8px">
          <span class="pill">Today total: <b id="todayTotal">0</b> kcal</span>
          <span class="pill">Remaining vs max: <b id="todayRemain">—</b></span>
        </div>
        <div style="overflow:auto;max-height:240px;margin-top:10px">
          <table id="foodTable">
            <thead><tr><th>Date</th><th>Food</th><th>Calories</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </details>

    <!-- HYDRATION -->
    <details class="card">
      <summary>Hydration</summary>
      <div class="content">
        <div class="row tiny">
          <span class="pill">Today water: <b id="todayWater">0</b> cups</span>
        </div>
        <div style="overflow:auto;max-height:240px;margin-top:10px">
          <table id="waterTable">
            <thead><tr><th>Date</th><th>Cups</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </details>

    <!-- CHART + STATS -->
    <details class="card">
      <summary>Chart & Stats</summary>
      <div class="content chart-row">
        <div id="chartWrap" class="grow">
          <canvas id="weightChart"></canvas>
          <div class="tiny muted" style="margin-top:6px">Progress toward goal</div>
          <div class="bar"><span id="progressBar"></span></div>
          <div class="tiny muted" id="progressLabel" style="margin-top:4px">0%</div>
        </div>
        <div class="stats">
          <div class="stat"><div class="tiny muted">First recorded</div><div id="firstVal">—</div></div>
          <div class="stat"><div class="tiny muted">Latest</div><div id="latestVal">—</div></div>
          <div class="stat"><div class="tiny muted">Change</div><div id="changeVal">—</div></div>
          <div class="stat"><div class="tiny muted">Avg/week</div><div id="rateVal">—</div></div>
          <div class="stat"><div class="tiny muted">Days left</div><div id="daysLeftVal">—</div></div>
        </div>
      </div>
    </details>

    <!-- WEIGHT ENTRIES -->
    <details class="card">
      <summary>Weight Entries</summary>
      <div class="content">
        <div class="tiny muted">Click **Edit** to load a row into the form above, then press **Save**.</div>
        <div style="overflow:auto;max-height:260px">
          <table id="logTable">
            <thead><tr><th>Date</th><th>Weight</th><th>Notes</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="clearAll" type="button">Clear ALL data</button>
          <small class="muted">Data is stored locally in this browser.</small>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="exportCsv" type="button">Export CSV</button>
          <input type="file" id="importCsv" accept=".csv" />
        </div>
      </div>
    </details>
  </div>

  <script>
    // ===== Keys & helpers =====
    const KEY_W = 'w360_weights';
    const KEY_F = 'w360_foods';
    const KEY_H = 'w360_water';
    const KEY_META = 'w360_meta';
    const todayISO = () => new Date().toISOString().slice(0,10);

    // ===== State =====
    let weights = [];   // [{date, weight, notes}]
    let foods = [];     // [{date, name, kcal}]
    let waters = [];    // [{date, cups}]
    let editingWeightIndex = null;
    let editingFoodIndex = null;
    let editingWaterIndex = null;

    // ===== Elements (cache) =====
    const dateEl = document.getElementById('date');
    const weightEl = document.getElementById('weight');
    const notesEl = document.getElementById('notes');
    const addWeightBtn = document.getElementById('addWeight');
    const saveWeightBtn = document.getElementById('saveWeight');

    const goalEl = document.getElementById('goal');
    const hdrGoal = document.getElementById('hdrGoal');
    const saveGoalBtn = document.getElementById('saveGoal');
    const clearGoalBtn = document.getElementById('clearGoal');

    const foodDate = document.getElementById('foodDate');
    const foodName = document.getElementById('foodName');
    const foodCals = document.getElementById('foodCals');
    const addFoodBtn = document.getElementById('addFood');

    const maintKcal = document.getElementById('maintKcal');
    const autoMaint = document.getElementById('autoMaint');

    const todayTotal = document.getElementById('todayTotal');
    const todayRemain = document.getElementById('todayRemain');

    const logTBody = document.querySelector('#logTable tbody');
    const foodTBody = document.querySelector('#foodTable tbody');
    const waterTBody = document.querySelector('#waterTable tbody');

    const importCsv = document.getElementById('importCsv');
    const exportCsvBtn = document.getElementById('exportCsv');
    const clearAllBtn = document.getElementById('clearAll');

    // Header quick-adds
    const quickWeight = document.getElementById('quickWeight');
    const quickCalories = document.getElementById('quickCalories');
    const quickWater = document.getElementById('quickWater');
    const quickWeightBtn = document.getElementById('quickWeightBtn');
    const quickCaloriesBtn = document.getElementById('quickCaloriesBtn');
    const quickWaterBtn = document.getElementById('quickWaterBtn');

    // Header progress + labels
    const headerBar = document.getElementById('headerProgressBar');
    const headerPct = document.getElementById('headerProgressLabel');
    const currentWeightLbl = document.getElementById('currentWeightLbl');

    // Name
    const nameInput = document.getElementById('nameInput');
    const saveNameBtn = document.getElementById('saveName');
    const clearNameBtn = document.getElementById('clearName');
    const nameDisplay = document.getElementById('nameDisplay');

    // ===== Storage =====
    function saveAll(){
      localStorage.setItem(KEY_W, JSON.stringify(weights));
      localStorage.setItem(KEY_F, JSON.stringify(foods));
      localStorage.setItem(KEY_H, JSON.stringify(waters));
      const meta = JSON.parse(localStorage.getItem(KEY_META) || '{}');
      meta.goal = goalEl.value || '';
      meta.maint = maintKcal?.value || '';
      meta.name = nameInput?.value || meta.name || '';
      localStorage.setItem(KEY_META, JSON.stringify(meta));
    }
    function loadAll(){
      try{ weights = JSON.parse(localStorage.getItem(KEY_W) || '[]'); } catch{ weights=[]; }
      try{ foods   = JSON.parse(localStorage.getItem(KEY_F) || '[]'); } catch{ foods=[]; }
      try{ waters  = JSON.parse(localStorage.getItem(KEY_H) || '[]'); } catch{ waters=[]; }
      const meta = JSON.parse(localStorage.getItem(KEY_META) || '{}');
      if(goalEl) goalEl.value = meta.goal || goalEl.value || '';
      if(maintKcal) maintKcal.value = meta.maint || '';
      if(nameInput && nameDisplay && meta.name){ nameInput.value = meta.name; nameDisplay.textContent = meta.name; }
      // keep weights ordered
      weights.sort((a,b)=> new Date(a.date) - new Date(b.date));
    }

    // ===== Rendering =====
    function renderWeights(){
      logTBody.innerHTML = '';
      weights.forEach((e,i)=>{
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        tr.innerHTML = `
          <td>${e.date}</td>
          <td>${Number(e.weight).toFixed(1)}</td>
          <td>${e.notes||''}</td>
          <td class="actions">
            <button class="editW">Edit</button>
            <button class="delW">Delete</button>
          </td>`;
        logTBody.appendChild(tr);
      });
      // header current weight label
      const last = weights.length ? weights[weights.length-1].weight : '';
      currentWeightLbl.textContent = last!=='' ? Number(last).toFixed(1) : '—';
      // stats
      renderStats();
    }

    function renderFoods(){
      foodTBody.innerHTML = '';
      foods.forEach((f,i)=>{
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        tr.innerHTML = `
          <td>${f.date}</td>
          <td>${f.name||''}</td>
          <td>${Number(f.kcal||0)}</td>
          <td class="actions">
            <button class="editF">Edit</button>
            <button class="delF">Delete</button>
          </td>`;
        foodTBody.appendChild(tr);
      });

      // Today total + remaining vs max
      const d = foodDate.value || todayISO();
      const todays = foods.filter(f=> f.date === d);
      const total = todays.reduce((s,f)=> s + (parseFloat(f.kcal)||0), 0);
      if(todayTotal) todayTotal.textContent = String(Math.round(total));

      const max =
        parseFloat(document.getElementById('maxCalPerDay')?.textContent || maintKcal?.value || '0') || 0;
      if(todayRemain) todayRemain.textContent = max>0 ? `${Math.round(max - total)} kcal` : '—';
    }

    function renderWater(){
      waterTBody.innerHTML = '';
      waters.forEach((w,i)=>{
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        tr.innerHTML = `
          <td>${w.date}</td>
          <td>${Number(w.cups)}</td>
          <td class="actions">
            <button class="editH">Edit</button>
            <button class="delH">Delete</button>
          </td>`;
        waterTBody.appendChild(tr);
      });

      const today = todayISO();
      const total = waters.filter(w=> w.date===today).reduce((s,w)=> s + (parseFloat(w.cups)||0), 0);
      const tw = document.getElementById('todayWater'); if(tw) tw.textContent = String(total);
    }

    // ===== Chart.js =====
    let weightChart = null;
    function updateChart(){
      const ctx = document.getElementById('weightChart');
      if(!ctx) return;

      const labels = weights.map(w => w.date);
      const series = weights.map(w => Number(w.weight));
      const goal = parseFloat(goalEl.value);

      const datasets = [];
      if(series.length){
        datasets.push({
          label: 'Weight',
          data: series,
          borderColor: '#f472b6',
          backgroundColor: 'rgba(244,114,182,0.2)',
          pointRadius: 3,
          tension: 0.25
        });
      }
      if(!isNaN(goal) && labels.length){
        datasets.push({
          label: 'Goal',
          data: labels.map(()=> goal),
          borderColor: '#ffd166',
          borderDash: [6,4],
          pointRadius: 0,
          tension: 0
        });
      }

      const config = {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.06)' } },
            y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.06)' } }
          },
          plugins: {
            legend: { labels: { color: '#e6eef8' } },
            tooltip: { mode: 'nearest', intersect: false }
          }
        }
      };

      if(weightChart){ weightChart.destroy(); }
      weightChart = new Chart(ctx, config);
    }

    function renderStats(){
      const firstVal = document.getElementById('firstVal');
      const latestVal = document.getElementById('latestVal');
      const changeVal = document.getElementById('changeVal');
      const rateVal = document.getElementById('rateVal');
      const daysLeftVal = document.getElementById('daysLeftVal');

      if(!weights.length){
        firstVal.textContent = latestVal.textContent = changeVal.textContent = rateVal.textContent = '—';
        daysLeftVal.textContent = '—';
        return;
      }

      const first = weights[0];
      const last  = weights[weights.length-1];

      firstVal.textContent  = `${first.weight.toFixed(1)} lbs (${first.date})`;
      latestVal.textContent = `${last.weight.toFixed(1)} lbs (${last.date})`;
      const diff = last.weight - first.weight;
      changeVal.textContent = (diff>=0?'+':'') + diff.toFixed(1) + ' lbs';

      // avg per week
      const d0 = new Date(first.date), d1 = new Date(last.date);
      const days = Math.max(1, Math.round((d1 - d0)/86400000));
      const perWeek = (diff / days) * 7;
      rateVal.textContent = (perWeek>=0?'+':'') + perWeek.toFixed(2) + ' lbs/wk';

      // days left to target date
      const targetTxt = document.getElementById('targetDateLbl').textContent;
      const target = new Date(targetTxt);
      const today = new Date(); today.setHours(0,0,0,0);
      const left = Math.ceil((target - today)/86400000);
      daysLeftVal.textContent = left >= 0 ? left + ' days' : '—';
    }

    function renderGoalAndProgress(){
      if(hdrGoal) hdrGoal.textContent = goalEl.value ? `${parseFloat(goalEl.value).toFixed(0)} lbs` : '—';

      const first   = weights.length ? parseFloat(weights[0].weight) : NaN;
      const current = weights.length ? parseFloat(weights[weights.length-1].weight) : NaN;
      const goal    = parseFloat(goalEl.value);

      const sectionBar = document.getElementById('progressBar');
      const sectionLbl = document.getElementById('progressLabel');

      if(isNaN(first) || isNaN(current) || isNaN(goal)){
        headerBar.style.width = '0%';
        headerPct.textContent = '0%';
        if(sectionBar) sectionBar.style.width = '0%';
        if(sectionLbl) sectionLbl.textContent = '0%';
        updateChart();
        return;
      }
      const span = first - goal;
      const done = first - current;
      const pct  = span>0 ? Math.max(0, Math.min(100, (done/span)*100)) : 0;

      headerBar.style.width = pct.toFixed(1) + '%';
      headerPct.textContent = pct.toFixed(1) + '%';
      if(sectionBar) sectionBar.style.width = pct.toFixed(1) + '%';
      if(sectionLbl) sectionLbl.textContent = pct.toFixed(1) + '%';

      updateChart();
    }

    function refresh(){
      renderWeights();
      renderFoods();
      renderWater();
      renderGoalAndProgress();
    }

    // ===== Events =====
    window.addEventListener('load', ()=>{
      if(dateEl) dateEl.value = todayISO();
      if(foodDate) foodDate.value = todayISO();

      // support legacy name
      const legacyName = localStorage.getItem('w360_name');
      if(legacyName && nameInput && nameDisplay){
        nameInput.value = legacyName; nameDisplay.textContent = legacyName;
      }

      loadAll();
      refresh();
    });

    // Weight add/save
    addWeightBtn.addEventListener('click', ()=>{
      const d = dateEl.value || todayISO();
      const w = parseFloat(weightEl.value);
      if(!d || isNaN(w)) return alert('Enter a date and valid weight');

      if(editingWeightIndex !== null){
        weights[editingWeightIndex] = {date:d, weight:w, notes:notesEl.value||''};
        editingWeightIndex = null; saveWeightBtn.style.display='none'; addWeightBtn.style.display='inline-block';
      } else {
        weights.push({date:d, weight:w, notes:notesEl.value||''});
      }
      weights.sort((a,b)=> new Date(a.date) - new Date(b.date));
      weightEl.value=''; notesEl.value='';
      saveAll(); refresh();
    });
    saveWeightBtn.addEventListener('click', ()=>{
      const i = editingWeightIndex; if(i===null || i<0 || i>=weights.length) return alert('Select a row to edit first');
      const d = dateEl.value; const w = parseFloat(weightEl.value);
      if(!d || isNaN(w)) return alert('Enter a date and valid weight');
      weights[i] = {date:d, weight:w, notes:notesEl.value||''};
      weights.sort((a,b)=> new Date(a.date) - new Date(b.date));
      editingWeightIndex = null; saveWeightBtn.style.display='none'; addWeightBtn.style.display='inline-block';
      weightEl.value=''; notesEl.value='';
      saveAll(); refresh();
    });

    // Food add/save
    addFoodBtn.addEventListener('click', ()=>{
      const d = foodDate.value || todayISO();
      const name = foodName.value || 'Quick entry';
      const kcal = parseFloat(foodCals.value);
      if(!d || isNaN(kcal)) return alert('Enter date and calories');

      if(editingFoodIndex !== null){
        foods[editingFoodIndex] = {date:d, name, kcal};
        editingFoodIndex = null;
      } else {
        foods.push({date:d, name, kcal});
      }
      foodName.value=''; foodCals.value='';
      saveAll(); refresh();
    });

    // Header quick: weight / calories / water
    quickWeightBtn.addEventListener('click', ()=>{
      const v = parseFloat(quickWeight.value);
      if(isNaN(v)) return alert('Enter a weight');
      const d = todayISO();
      weights.push({date:d, weight:v, notes:''});
      weights.sort((a,b)=> new Date(a.date) - new Date(b.date));
      quickWeight.value='';
      saveAll(); refresh();
    });
    quickCaloriesBtn.addEventListener('click', ()=>{
      const cals = parseFloat(quickCalories.value);
      if(isNaN(cals)) return alert('Enter calories');
      foods.push({date:todayISO(), name:'Quick entry', kcal:cals});
      quickCalories.value='';
      saveAll(); refresh();
    });
    quickWaterBtn.addEventListener('click', ()=>{
      const cups = parseFloat(quickWater.value);
      if(isNaN(cups)) return alert('Enter water in cups');
      const d = todayISO();
      if(editingWaterIndex !== null){
        waters[editingWaterIndex] = {date:d, cups};
        editingWaterIndex = null;
      } else {
        waters.push({date:d, cups});
      }
      quickWater.value='';
      saveAll(); refresh();
    });

    // Goal & Name
    saveGoalBtn.addEventListener('click', ()=>{ saveAll(); refresh(); });
    clearGoalBtn.addEventListener('click', ()=>{ goalEl.value=''; saveAll(); refresh(); });
    saveNameBtn.addEventListener('click', ()=>{ nameDisplay.textContent = nameInput.value || '—'; saveAll(); });
    clearNameBtn.addEventListener('click', ()=>{ nameInput.value=''; nameDisplay.textContent='—'; saveAll(); });

    // Auto maintenance estimate (12 × current lbs)
    autoMaint.addEventListener('click', ()=>{
      const current = weights.length ? parseFloat(weights[weights.length-1].weight) : NaN;
      if(isNaN(current)) return alert('Add a weight entry first.');
      maintKcal.value = Math.round(current * 12);
      saveAll(); refresh();
    });

    // Export/Import CSV
    exportCsvBtn.addEventListener('click', ()=>{
      const rows = [['type','date','value1','value2']];
      weights.forEach(e=> rows.push(['weight', e.date, e.weight, e.notes||'']));
      foods.forEach(f  => rows.push(['food',   f.date, f.name||'', f.kcal||0]));
      waters.forEach(h => rows.push(['water',  h.date, h.cups||0, '' ]));
      const csv = rows.map(r =>
        r.map(x => String(x).includes(',') ? `"${String(x).replace(/"/g,'""')}"` : x).join(',')
      ).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'weight360_export.csv';
      a.click(); URL.revokeObjectURL(url);
    });
    importCsv.addEventListener('change', ev=>{
      const file = ev.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        const lines = e.target.result.split(/\r?\n/).filter(Boolean);
        for(let i=1;i<lines.length;i++){
          const cols = parseCSVLine(lines[i]);
          const type = (cols[0]||'').toLowerCase();
          if(type==='weight'){
            const [_,d,w,notes] = cols; const num = parseFloat(w);
            if(d && !isNaN(num)) weights.push({date:d, weight:num, notes:notes||''});
          } else if(type==='food'){
            const [_,d,name,kcal] = cols; const num = parseFloat(kcal);
            if(d && !isNaN(num)) foods.push({date:d, name:name||'', kcal:num});
          } else if(type==='water'){
            const [_,d,cups] = cols; const num = parseFloat(cups);
            if(d && !isNaN(num)) waters.push({date:d, cups:num});
          }
        }
        weights.sort((a,b)=> new Date(a.date)-new Date(b.date));
        saveAll(); refresh();
        importCsv.value='';
      };
      reader.readAsText(file);
    });
    function parseCSVLine(line){
      const out=[]; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const c=line[i];
        if(c=='"'){ if(inQ && line[i+1]=='"'){ cur+='"'; i++; } else { inQ=!inQ; } }
        else if(c==',' && !inQ){ out.push(cur); cur=''; }
        else cur+=c;
      }
      out.push(cur); return out;
    }

    // ===== Event delegation for Edit/Delete (reliable even for new rows) =====
    logTBody.addEventListener('click', (e)=>{
      const tr = e.target.closest('tr'); if(!tr) return;
      const idx = +tr.dataset.index;
      if(e.target.classList.contains('editW')){
        const row = weights[idx];
        editingWeightIndex = idx;
        dateEl.value = row.date; weightEl.value = row.weight; notesEl.value = row.notes||'';
        addWeightBtn.style.display='none'; saveWeightBtn.style.display='inline-block';
      } else if(e.target.classList.contains('delW')){
        if(confirm('Delete this weight entry?')){ weights.splice(idx,1); saveAll(); refresh(); }
      }
    });
    foodTBody.addEventListener('click', (e)=>{
      const tr = e.target.closest('tr'); if(!tr) return;
      const idx = +tr.dataset.index;
      if(e.target.classList.contains('editF')){
        const row = foods[idx];
        editingFoodIndex = idx;
        foodDate.value = row.date; foodName.value = row.name||''; foodCals.value = row.kcal||'';
      } else if(e.target.classList.contains('delF')){
        if(confirm('Delete this food item?')){ foods.splice(idx,1); saveAll(); refresh(); }
      }
    });
    waterTBody.addEventListener('click', (e)=>{
      const tr = e.target.closest('tr'); if(!tr) return;
      const idx = +tr.dataset.index;
      if(e.target.classList.contains('editH')){
        const row = waters[idx];
        editingWaterIndex = idx;
        quickWater.value = row.cups;
      } else if(e.target.classList.contains('delH')){
        if(confirm('Delete this water entry?')){ waters.splice(idx,1); saveAll(); refresh(); }
      }
    });

    // Clear All with confirmation
    clearAllBtn.addEventListener('click', ()=>{
      const ans = prompt('Are you sure? Type "yes" to clear ALL data and start over.');
      if(ans && ans.toLowerCase()==='yes'){
        weights=[]; foods=[]; waters=[];
        localStorage.removeItem(KEY_W);
        localStorage.removeItem(KEY_F);
        localStorage.removeItem(KEY_H);
        localStorage.removeItem(KEY_META); // remove this line if you want to keep name/goal
        saveAll(); refresh();
      }
    });
  </script>
</body>
</html>
