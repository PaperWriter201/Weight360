<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weight360</title>

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png?v=2">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png?v=2">
  <meta name="theme-color" content="#0f1724">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>

  <style>
    :root{
      --bg:#0f1724;--card:#0b1220;--accent:#60a5fa;--muted:#94a3b8;--gold:#ffd166;--pink:#f472b6;color-scheme:dark
    }
    html,body{
      margin:0;background:linear-gradient(180deg,#071026 0%, #071827 100%);color:#e6eef8;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial
    }
    .wrap{max-width:980px;margin:16px auto;padding:0 14px}
    header.hero{
      display:flex;flex-direction:column;gap:12px;margin-bottom:16px;padding:18px 20px;border-radius:16px;
      background:linear-gradient(135deg, rgba(255,95,162,0.18), rgba(96,165,250,0.12));
      border:1px solid rgba(255,95,162,0.35);box-shadow:0 10px 30px rgba(2,6,23,0.45)
    }
    h1{font-size:1.4rem;margin:0;color:var(--pink)}
    .tiny{font-size:.9rem}.muted{color:var(--muted)}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:12px;padding:0;margin-bottom:14px;box-shadow:0 6px 20px rgba(2,6,23,0.6);border:1px solid var(--pink)
    }
    .card summary{cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:14px;font-size:1rem;color:var(--pink)}
    .card summary::after{content:"‚ñ∂";color:var(--pink);transition:transform .3s}
    .card[open] summary::after{transform:rotate(90deg)}
    .card .content{padding:0 14px 14px}
    input,button{
      padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);
      background:transparent;color:inherit;min-height:34px;font-size:.9rem
    }
    input[type="date"]{min-width:120px}
    button{cursor:pointer}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grow{flex:1 1 200px}
    .right{margin-left:auto}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.06)}
    table{width:100%;border-collapse:collapse;margin-top:8px;table-layout:fixed}
    th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.06);font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    td.actions{text-align:right;white-space:nowrap}
    .bar{height:12px;border-radius:8px;background:#1f2a44;overflow:hidden}
    .bar>span{display:block;height:100%;background:var(--gold);width:0%}

    /* Header logo */
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:40px;width:auto;display:block}
    @media(max-width:480px){ .brand img{height:32px} }

    /* CHART FIX: stable height & no overlap */
    #chartWrap { position: relative; width: 100%; height: 260px; margin-top: 10px; }
    #weightChart { position: absolute; inset: 0; width: 100% !important; height: 100% !important; display:block; }
    .chart-row{display:flex;gap:12px;align-items:flex-start}
    .stats{flex:1 1 35%;display:flex;flex-direction:column;gap:8px}
    .stat{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
    @media(max-width:780px){.chart-row{flex-direction:column}}

    /* Icon buttons */
    .icon-btn{border:1px solid rgba(255,255,255,0.12);background:rgba(255,255,255,0.02);padding:4px 8px;border-radius:8px;font-size:.9rem}
    .icon-btn.edit{color:#a7f3d0}     /* mint */
    .icon-btn.del{color:#fecaca}      /* soft red */

    /* Summary chips */
    .chipbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--gold);background:rgba(255,255,255,0.03);cursor:pointer}
    .chip.active{background:rgba(255,209,102,0.15)}

    /* Summary note in weights list */
    .summary-note{font-style:italic;color:#eab308}
    .hide{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:20px;flex-wrap:wrap">
        <div>
          <div class="brand">
            <img src="logo-hero.png" alt="Weight360 logo">
            <h1>Weight360</h1>
          </div>
          <div class="tiny muted">Private weight, calories, water & exercise ‚Äî saved locally on this device</div>
          <div class="tiny muted" style="margin-top:6px">Target date: <b id="targetDateLbl">Jan 1, 2026</b></div>
          <div class="row" style="margin-top:8px">
            <input id="nameInput" placeholder="Your name" style="width:160px">
            <span id="nameBtns">
              <button id="saveName" type="button">Set</button>
              <button id="clearName" type="button">Clear</button>
            </span>
            <span class="pill tiny">Hi, <b id="nameDisplay">‚Äî</b></span>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
          <div class="row" style="gap:6px">
            <input type="number" step="0.1" id="quickWeight" placeholder="Weight" style="width:100px">
            <button id="quickWeightBtn" type="button">Add</button>
          </div>
          <div class="row" style="gap:6px">
            <input type="number" id="quickCalories" placeholder="Calories" style="width:100px">
            <button id="quickCaloriesBtn" type="button">Add</button>
          </div>
          <div class="row" style="gap:6px">
            <input type="number" id="quickWater" placeholder="Water (cups)" style="width:110px">
            <button id="quickWaterBtn" type="button">Add</button>
          </div>
        </div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:20px;margin-top:10px">
        <div class="bar" style="flex:1"><span id="headerProgressBar"></span></div>
        <div class="tiny muted">Current: <b id="currentWeightLbl">‚Äî</b></div>
        <div class="tiny muted" id="headerProgressLabel">0%</div>
      </div>
    </header>

    <!-- WEIGHT TRACKER (closed by default) -->
    <details class="card">
      <summary>Weight Tracker</summary>
      <div class="content">
        <div class="row">
          <div class="grow">
            <label class="tiny muted">Date</label><br/>
            <input type="date" id="date">
          </div>
          <div>
            <label class="tiny muted">Weight (lbs)</label><br/>
            <input type="number" step="0.1" id="weight" placeholder="e.g. 238.6">
          </div>
          <div class="grow">
            <label class="tiny muted">Notes</label><br/>
            <input type="text" id="notes" placeholder="morning weigh-in, gym, etc.">
          </div>
          <div>
            <button id="addWeight" type="button">Add</button>
            <button id="saveWeight" type="button" class="hide">Save</button>
          </div>
        </div>
        <div class="row" style="margin-top:10px;align-items:center;gap:8px">
          <label class="tiny muted">Goal (lbs)</label>
          <input type="number" step="0.1" id="goal" placeholder="190" style="width:120px">
          <button id="saveGoal" type="button">Set</button>
          <button id="clearGoal" type="button" title="Clear saved goal">Clear</button>
          <span class="pill tiny">Current goal: <b id="hdrGoal">‚Äî</b></span>
        </div>
      </div>
    </details>

    <!-- FOOD & CALORIES -->
    <details class="card">
      <summary>Food & Calories</summary>
      <div class="content">
        <div class="row">
          <div><label class="tiny muted">Date</label><br/><input type="date" id="foodDate"></div>
          <div class="grow"><label class="tiny muted">Food</label><br/><input id="foodName" placeholder="eggs & toast"></div>
          <div><label class="tiny muted">Calories</label><br/><input type="number" id="foodCals" placeholder="320"></div>
          <div><button id="addFood" type="button">Add food</button></div>
          <div class="right">
            <label class="tiny muted">Maintenance kcal/day</label><br/>
            <input type="number" id="maintKcal" placeholder="auto" style="width:160px">
            <button id="autoMaint" type="button" title="Rough estimate: 12 √ó current weight">Auto</button>
          </div>
        </div>
        <div class="row tiny" style="margin-top:8px">
          <span class="pill">Today food: <b id="todayTotal">0</b> kcal</span>
          <span class="pill">Today exercise: <b id="todayExCals">0</b> kcal</span>
          <span class="pill">Net calories: <b id="todayNetCals">‚Äî</b></span>
          <span class="pill">Remaining vs max: <b id="todayRemain">‚Äî</b></span>
        </div>
        <div style="overflow:auto;max-height:240px;margin-top:10px">
          <table id="foodTable">
            <thead><tr><th style="width:24%">Date</th><th style="width:46%">Food</th><th style="width:20%">Calories</th><th style="width:10%"></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </details>

    <!-- HYDRATION -->
    <details class="card">
      <summary>Hydration</summary>
      <div class="content">
        <div class="row tiny">
          <span class="pill">Today water: <b id="todayWater">0</b> cups</span>
        </div>
        <div style="overflow:auto;max-height:240px;margin-top:10px">
          <table id="waterTable">
            <thead><tr><th style="width:40%">Date</th><th style="width:40%">Cups</th><th style="width:20%"></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </details>

    <!-- EXERCISE -->
    <details class="card">
      <summary>Exercise</summary>
      <div class="content">
        <div class="row">
          <div><label class="tiny muted">Date</label><br/><input type="date" id="exDate"></div>
          <div class="grow"><label class="tiny muted">Activity</label><br/><input id="exActivity" placeholder="Walking, Gym, etc."></div>
          <div><label class="tiny muted">Miles</label><br/><input type="number" step="0.1" id="exMiles" placeholder="2.5"></div>
          <div><label class="tiny muted">Calories Burned</label><br/><input type="number" id="exCals" placeholder="200"></div>
          <div><button id="addEx" type="button">Add Exercise</button></div>
        </div>
        <div style="overflow:auto;max-height:240px;margin-top:10px">
          <table id="exTable">
            <thead><tr><th style="width:24%">Date</th><th style="width:36%">Activity</th><th style="width:20%">Miles</th><th style="width:10%">Cals</th><th style="width:10%"></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </details>

    <!-- CHART + STATS -->
    <details class="card">
      <summary>Chart & Stats</summary>
      <div class="content chart-row">
        <div id="chartWrap" class="grow">
          <canvas id="weightChart"></canvas>
          <div class="tiny muted" style="margin-top:6px">Progress toward goal</div>
          <div class="bar"><span id="progressBar"></span></div>
          <div class="tiny muted" id="progressLabel" style="margin-top:4px">0%</div>
        </div>
        <div class="stats">
          <div class="stat"><div class="tiny muted">First recorded</div><div id="firstVal">‚Äî</div></div>
          <div class="stat"><div class="tiny muted">Latest</div><div id="latestVal">‚Äî</div></div>
          <div class="stat"><div class="tiny muted">Change</div><div id="changeVal">‚Äî</div></div>
          <div class="stat"><div class="tiny muted">Avg/week</div><div id="rateVal">‚Äî</div></div>
          <div class="stat"><div class="tiny muted">Days left</div><div id="daysLeftVal">‚Äî</div></div>
        </div>
      </div>
    </details>

    <!-- DAILY SUMMARY LOG -->
    <details class="card">
      <summary>Daily Summary Log</summary>
      <div class="content">
        <div class="tiny muted">These are read-only rollups for each day. Click a date chip to view.</div>
        <div id="summaryChips" class="chipbar"></div>
        <div id="summaryView" style="margin-top:10px">
          <div class="row">
            <span class="pill">Date: <b id="sumDate">‚Äî</b></span>
            <span class="pill">Weight: <b id="sumWeight">‚Äî</b></span>
            <span class="pill">Food: <b id="sumFood">0</b> kcal</span>
            <span class="pill">Exercise: <b id="sumEx">0</b> kcal</span>
            <span class="pill">Net: <b id="sumNetCals">‚Äî</b> kcal</span>
            <span class="pill">Water: <b id="sumWater">0</b> cups</span>
          </div>
          <div class="row" style="margin-top:8px">
            <small class="muted">To change a day‚Äôs data, edit entries in the sections above; summaries update automatically.</small>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="exportCsv" type="button">Export CSV</button>
          <input type="file" id="importCsv" accept=".csv" />
          <div class="right">
            <button id="clearAll" type="button">Clear ALL data</button>
          </div>
        </div>
      </div>
    </details>
  </div>

  <script>
    // ===== Keys & helpers =====
    const KEY_W = 'w360_weights';
    const KEY_F = 'w360_foods';
    const KEY_H = 'w360_water';
    const KEY_X = 'w360_exercise';
    const KEY_META = 'w360_meta';
    const todayISO = () => new Date().toISOString().slice(0,10);

    // ===== State =====
    let weights = [];    // [{date, weight, notes, _summary?}]
    let foods = [];      // [{date, name, kcal}]
    let waters = [];     // [{date, cups}]
    let exercises = [];  // [{date, activity, miles, kcal}]
    let editingWeightIndex = null;
    let editingFoodIndex = null;
    let editingWaterIndex = null;
    let editingExIndex = null;

    // ===== Elements =====
    const dateEl = document.getElementById('date');
    const weightEl = document.getElementById('weight');
    const notesEl = document.getElementById('notes');
    const addWeightBtn = document.getElementById('addWeight');
    const saveWeightBtn = document.getElementById('saveWeight');

    const goalEl = document.getElementById('goal');
    const hdrGoal = document.getElementById('hdrGoal');
    const saveGoalBtn = document.getElementById('saveGoal');
    const clearGoalBtn = document.getElementById('clearGoal');

    const foodDate = document.getElementById('foodDate');
    const foodName = document.getElementById('foodName');
    const foodCals = document.getElementById('foodCals');
    const addFoodBtn = document.getElementById('addFood');

    const maintKcal = document.getElementById('maintKcal');
    const autoMaint = document.getElementById('autoMaint');

    const todayTotal = document.getElementById('todayTotal');
    const todayExCals = document.getElementById('todayExCals');
    const todayNetCals = document.getElementById('todayNetCals');
    const todayRemain = document.getElementById('todayRemain');

    const logTBody = document.querySelector('#logTable tbody');
    const foodTBody = document.querySelector('#foodTable tbody');
    const waterTBody = document.querySelector('#waterTable tbody');
    const exTBody = document.querySelector('#exTable tbody');

    const exDate = document.getElementById('exDate');
    const exActivity = document.getElementById('exActivity');
    const exMiles = document.getElementById('exMiles');
    const exCals = document.getElementById('exCals');
    const addExBtn = document.getElementById('addEx');

    const importCsv = document.getElementById('importCsv');
    const exportCsvBtn = document.getElementById('exportCsv');
    const clearAllBtn = document.getElementById('clearAll');

    // Header quick-adds
    const quickWeight = document.getElementById('quickWeight');
    const quickCalories = document.getElementById('quickCalories');
    const quickWater = document.getElementById('quickWater');
    const quickWeightBtn = document.getElementById('quickWeightBtn');
    const quickCaloriesBtn = document.getElementById('quickCaloriesBtn');
    const quickWaterBtn = document.getElementById('quickWaterBtn');

    // Header progress + labels
    const headerBar = document.getElementById('headerProgressBar');
    const headerPct = document.getElementById('headerProgressLabel');
    const currentWeightLbl = document.getElementById('currentWeightLbl');

    // Name
    const nameInput = document.getElementById('nameInput');
    const nameBtns = document.getElementById('nameBtns');
    const saveNameBtn = document.getElementById('saveName');
    const clearNameBtn = document.getElementById('clearName');
    const nameDisplay = document.getElementById('nameDisplay');

    // Summary (log) UI
    const chipsWrap = document.getElementById('summaryChips');
    const sumDate = document.getElementById('sumDate');
    const sumWeight = document.getElementById('sumWeight');
    const sumFood = document.getElementById('sumFood');
    const sumEx = document.getElementById('sumEx');
    const sumNet = document.getElementById('sumNetCals');
    const sumWater = document.getElementById('sumWater');

    // ===== Storage =====
    function saveAll(){
      localStorage.setItem(KEY_W, JSON.stringify(weights));
      localStorage.setItem(KEY_F, JSON.stringify(foods));
      localStorage.setItem(KEY_H, JSON.stringify(waters));
      localStorage.setItem(KEY_X, JSON.stringify(exercises));
      const meta = JSON.parse(localStorage.getItem(KEY_META) || '{}');
      meta.goal = goalEl.value || '';
      meta.maint = maintKcal?.value || '';
      meta.name = nameInput?.value || meta.name || '';
      localStorage.setItem(KEY_META, JSON.stringify(meta));
    }
    function loadAll(){
      try{ weights   = JSON.parse(localStorage.getItem(KEY_W) || '[]'); } catch{ weights=[]; }
      try{ foods     = JSON.parse(localStorage.getItem(KEY_F) || '[]'); } catch{ foods=[]; }
      try{ waters    = JSON.parse(localStorage.getItem(KEY_H) || '[]'); } catch{ waters=[]; }
      try{ exercises = JSON.parse(localStorage.getItem(KEY_X) || '[]'); } catch{ exercises=[]; }
      const meta = JSON.parse(localStorage.getItem(KEY_META) || '{}');
      goalEl.value = meta.goal || goalEl.value || '';
      if(maintKcal) maintKcal.value = meta.maint || '';
      if(meta.name){ nameInput.value = meta.name; nameDisplay.textContent = meta.name; nameBtns.classList.add('hide'); }
      // keep ordered by date
      weights.sort((a,b)=> new Date(a.date) - new Date(b.date));
      foods.sort((a,b)=> new Date(a.date) - new Date(b.date));
      waters.sort((a,b)=> new Date(a.date) - new Date(b.date));
      exercises.sort((a,b)=> new Date(a.date) - new Date(b.date));
    }

    // ===== Helpers (totals) =====
    function totalsForDate(d){
      const foodKcal = foods.filter(f=>f.date===d).reduce((s,f)=>s+(+f.kcal||0),0);
      const exKcal   = exercises.filter(x=>x.date===d).reduce((s,x)=>s+(+x.kcal||0),0);
      const cups     = waters.filter(w=>w.date===d).reduce((s,w)=>s+(+w.cups||0),0);
      const weightRow= weights.filter(w=> w.date===d && !w._summary).slice(-1)[0];
      const net      = Math.max(0, foodKcal - exKcal);
      return {foodKcal, exKcal, cups, net, weightVal: weightRow? +weightRow.weight : null};
    }
    function distinctDays(){
      const set = new Set();
      weights.forEach(w=>set.add(w.date));
      foods.forEach(f=>set.add(f.date));
      waters.forEach(w=>set.add(w.date));
      exercises.forEach(x=>set.add(x.date));
      return Array.from(set).sort((a,b)=> new Date(b)-new Date(a)); // newest first
    }

    // ===== Rendering =====
    function renderWeights(){
      logTBody.innerHTML = '';
      weights.forEach((e,i)=>{
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        const isSummary = e._summary === true;
        tr.innerHTML = `
          <td>${e.date}</td>
          <td>${isSummary ? '<span class="summary-note">‚Äî</span>' : Number(e.weight).toFixed(1)}</td>
          <td>${isSummary ? `<span class="summary-note">${e.notes||''}</span>` : (e.notes||'')}</td>
          <td class="actions">
            ${isSummary ? '' : '<button class="icon-btn edit editW" title="Edit">‚úèÔ∏è</button>'}
            <button class="icon-btn del delW" title="Delete">üóëÔ∏è</button>
          </td>`;
        logTBody.appendChild(tr);
      });
      const nonSummary = weights.filter(w=>!w._summary);
      const last = nonSummary.length ? nonSummary[nonSummary.length-1].weight : '';
      currentWeightLbl.textContent = (last!=='' && !isNaN(last)) ? Number(last).toFixed(1) : '‚Äî';
      renderStats();
    }

    function renderFoods(){
      foodTBody.innerHTML = '';
      foods.forEach((f,i)=>{
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        tr.innerHTML = `
          <td>${f.date}</td>
          <td>${f.name||''}</td>
          <td>${Number(f.kcal||0)}</td>
          <td class="actions">
            <button class="icon-btn edit editF" title="Edit">‚úèÔ∏è</button>
            <button class="icon-btn del delF" title="Delete">üóëÔ∏è</button>
          </td>`;
        foodTBody.appendChild(tr);
      });
      updateFoodExerciseTotals();
    }

    function renderWater(){
      waterTBody.innerHTML = '';
      waters.forEach((w,i)=>{
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        tr.innerHTML = `
          <td>${w.date}</td>
          <td>${Number(w.cups)}</td>
          <td class="actions">
            <button class="icon-btn edit editH" title="Edit">‚úèÔ∏è</button>
            <button class="icon-btn del delH" title="Delete">üóëÔ∏è</button>
          </td>`;
        waterTBody.appendChild(tr);
      });
      const d = foodDate.value || todayISO();
      const t = totalsForDate(d);
      document.getElementById('todayWater').textContent = String(t.cups);
    }

    function renderExercise(){
      exTBody.innerHTML = '';
      exercises.forEach((x,i)=>{
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        tr.innerHTML = `
          <td>${x.date}</td>
          <td>${x.activity||''}</td>
          <td>${Number(x.miles||0)}</td>
          <td>${Number(x.kcal||0)}</td>
          <td class="actions">
            <button class="icon-btn edit editX" title="Edit">‚úèÔ∏è</button>
            <button class="icon-btn del delX" title="Delete">üóëÔ∏è</button>
          </td>`;
        exTBody.appendChild(tr);
      });
      updateFoodExerciseTotals();
    }

    function updateFoodExerciseTotals(){
      const d = foodDate.value || todayISO();
      const t = totalsForDate(d);
      todayTotal.textContent = String(Math.round(t.foodKcal));
      todayExCals.textContent = String(Math.round(t.exKcal));
      todayNetCals.textContent = String(Math.round(t.net));
      const max =
        parseFloat(document.getElementById('maxCalPerDay')?.textContent || maintKcal?.value || '0') || 0;
      todayRemain.textContent = max>0 ? `${Math.round(max - t.net)} kcal` : '‚Äî';
      renderSummaryChips();
      renderSummaryView(d);
    }

    // Summary chips & view
    function renderSummaryChips(){
      const days = distinctDays();
      chipsWrap.innerHTML = '';
      days.forEach((d,idx)=>{
        const chip = document.createElement('button');
        chip.className = 'chip' + (idx===0 ? ' active' : '');
        const mmdd = new Date(d); const label = (mmdd.getMonth()+1)+'/'+mmdd.getDate();
        chip.textContent = label;
        chip.title = d;
        chip.onclick = ()=>{
          chipsWrap.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
          chip.classList.add('active');
          renderSummaryView(d);
        };
        chipsWrap.appendChild(chip);
      });
      if(days.length){ renderSummaryView(days[0]); }
    }
    function renderSummaryView(d){
      const t = totalsForDate(d);
      sumDate.textContent = d;
      sumWeight.textContent = (t.weightVal!=null && !isNaN(t.weightVal)) ? t.weightVal.toFixed(1)+' lbs' : '‚Äî';
      sumFood.textContent = String(Math.round(t.foodKcal));
      sumEx.textContent = String(Math.round(t.exKcal));
      sumNet.textContent = String(Math.round(t.net));
      sumWater.textContent = String(t.cups);
    }

    // ===== Chart.js =====
    let weightChart = null;
    function updateChart(){
      const ctx = document.getElementById('weightChart');
      if(!ctx) return;

      const nonSummary = weights.filter(w=>!w._summary);
      const labels = nonSummary.map(w => w.date);
      const series = nonSummary.map(w => Number(w.weight));
      const goal = parseFloat(goalEl.value);

      const datasets = [];
      if(series.length){
        datasets.push({
          label: 'Weight',
          data: series,
          borderColor: '#f472b6',
          backgroundColor: 'rgba(244,114,182,0.2)',
          pointRadius: 3,
          tension: 0.25
        });
      }
      if(!isNaN(goal) && labels.length){
        datasets.push({
          label: 'Goal',
          data: labels.map(()=> goal),
          borderColor: '#ffd166',
          borderDash: [6,4],
          pointRadius: 0,
          tension: 0
        });
      }

      const config = {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { top: 6, right: 6, bottom: 6, left: 6 } },
          scales: {
            x: { ticks: { color: '#94a3b8', maxRotation: 0, autoSkip: true }, grid: { color: 'rgba(255,255,255,0.06)' } },
            y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.06)' } }
          },
          plugins: {
            legend: { position: 'bottom', labels: { color: '#e6eef8' } },
            tooltip: { mode: 'nearest', intersect: false }
          }
        }
      };

      if(weightChart){ weightChart.destroy(); }
      weightChart = new Chart(ctx, config);
    }

    function renderStats(){
      const firstVal = document.getElementById('firstVal');
      const latestVal = document.getElementById('latestVal');
      const changeVal = document.getElementById('changeVal');
      const rateVal = document.getElementById('rateVal');
      const daysLeftVal = document.getElementById('daysLeftVal');

      const nonSummary = weights.filter(w=>!w._summary);
      if(!nonSummary.length){
        firstVal.textContent = latestVal.textContent = changeVal.textContent = rateVal.textContent = '‚Äî';
        daysLeftVal.textContent = '‚Äî';
        return;
      }

      const first = nonSummary[0];
      const last  = nonSummary[nonSummary.length-1];

      firstVal.textContent  = `${Number(first.weight).toFixed(1)} lbs (${first.date})`;
      latestVal.textContent = `${Number(last.weight).toFixed(1)} lbs (${last.date})`;
      const diff = last.weight - first.weight;
      changeVal.textContent = (diff>=0?'+':'') + diff.toFixed(1) + ' lbs';

      const d0 = new Date(first.date), d1 = new Date(last.date);
      const days = Math.max(1, Math.round((d1 - d0)/86400000));
      const perWeek = (diff / days) * 7;
      rateVal.textContent = (perWeek>=0?'+':'') + perWeek.toFixed(2) + ' lbs/wk';

      const targetTxt = document.getElementById('targetDateLbl').textContent;
      const target = new Date(targetTxt);
      const today = new Date(); today.setHours(0,0,0,0);
      const left = Math.ceil((target - today)/86400000);
      daysLeftVal.textContent = left >= 0 ? left + ' days' : '‚Äî';
    }

    function renderGoalAndProgress(){
      hdrGoal.textContent = goalEl.value ? `${parseFloat(goalEl.value).toFixed(0)} lbs` : '‚Äî';
      const nonSummary = weights.filter(w=>!w._summary);
      const first   = nonSummary.length ? parseFloat(nonSummary[0].weight) : NaN;
      const current = nonSummary.length ? parseFloat(nonSummary[nonSummary.length-1].weight) : NaN;
      const goal    = parseFloat(goalEl.value);

      const sectionBar = document.getElementById('progressBar');
      const sectionLbl = document.getElementById('progressLabel');

      if(isNaN(first) || isNaN(current) || isNaN(goal)){
        headerBar.style.width = '0%'; headerPct.textContent = '0%';
        sectionBar.style.width = '0%'; sectionLbl.textContent = '0%';
        updateChart();
        return;
      }
      const span = first - goal;
      const done = first - current;
      const pct  = span>0 ? Math.max(0, Math.min(100, (done/span)*100)) : 0;

      headerBar.style.width = pct.toFixed(1) + '%';
      headerPct.textContent = pct.toFixed(1) + '%';
      sectionBar.style.width = pct.toFixed(1) + '%';
      sectionLbl.textContent = pct.toFixed(1) + '%';

      updateChart();
    }

    function refresh(){
      renderWeights();
      renderFoods();
      renderWater();
      renderExercise();
      renderGoalAndProgress();
    }

    // ===== Events =====
    window.addEventListener('load', ()=>{
      dateEl.value = todayISO();
      foodDate.value = todayISO();
      exDate.value = todayISO();
      loadAll();
      refresh();
    });

    // Name controls hide/show
    saveNameBtn.onclick = ()=>{ nameDisplay.textContent = nameInput.value || '‚Äî'; nameBtns.classList.add('hide'); saveAll(); };
    clearNameBtn.onclick = ()=>{ nameInput.value=''; nameDisplay.textContent='‚Äî'; nameBtns.classList.remove('hide'); saveAll(); };

    // Weight add/save
    addWeightBtn.onclick = ()=>{
      const d = dateEl.value || todayISO();
      const w = parseFloat(weightEl.value);
      if(!d || isNaN(w)) return alert('Enter a date and valid weight');

      if(editingWeightIndex !== null){
        weights[editingWeightIndex] = {date:d, weight:w, notes:notesEl.value||''};
        editingWeightIndex = null; saveWeightBtn.classList.add('hide'); addWeightBtn.classList.remove('hide');
      } else {
        weights.push({date:d, weight:w, notes:notesEl.value||''});
      }
      weights.sort((a,b)=> new Date(a.date) - new Date(b.date));
      weightEl.value=''; notesEl.value='';
      saveAll(); refresh();
    };
    saveWeightBtn.onclick = ()=>{
      const i = editingWeightIndex; if(i===null || i<0 || i>=weights.length) return alert('Select a row to edit first');
      const d = dateEl.value; const w = parseFloat(weightEl.value);
      if(!d || isNaN(w)) return alert('Enter a date and valid weight');
      weights[i] = {date:d, weight:w, notes:notesEl.value||''};
      weights.sort((a,b)=> new Date(a.date) - new Date(b.date));
      editingWeightIndex = null; saveWeightBtn.classList.add('hide'); addWeightBtn.classList.remove('hide');
      weightEl.value=''; notesEl.value='';
      saveAll(); refresh();
    };

    // Food add
    addFoodBtn.onclick = ()=>{
      const d = foodDate.value || todayISO();
      const name = foodName.value || 'Quick entry';
      const kcal = parseFloat(foodCals.value);
      if(!d || isNaN(kcal)) return alert('Enter date and calories');
      foods.push({date:d, name, kcal});
      foodName.value=''; foodCals.value='';
      saveAll(); refresh();
    };

    // Quick header adders
    quickWeightBtn.onclick = ()=>{
      const v = parseFloat(quickWeight.value);
      if(isNaN(v)) return alert('Enter a weight');
      const d = todayISO();
      weights.push({date:d, weight:v, notes:''});
      weights.sort((a,b)=> new Date(a.date) - new Date(b.date));
      quickWeight.value=''; saveAll(); refresh();
    };
    quickCaloriesBtn.onclick = ()=>{
      const cals = parseFloat(quickCalories.value);
      if(isNaN(cals)) return alert('Enter calories');
      foods.push({date:todayISO(), name:'Quick entry', kcal:cals});
      quickCalories.value=''; saveAll(); refresh();
    };
    quickWaterBtn.onclick = ()=>{
      const cups = parseFloat(quickWater.value);
      if(isNaN(cups)) return alert('Enter water in cups');
      waters.push({date:todayISO(), cups});
      quickWater.value=''; saveAll(); refresh();
    };

    // Exercise add
    addExBtn.onclick = ()=>{
      const d = exDate.value || todayISO();
      const act = exActivity.value || 'Exercise';
      const miles = parseFloat(exMiles.value)||0;
      const kcal = parseFloat(exCals.value)||0;
      if(!d) return alert('Enter a date');
      exercises.push({date:d, activity:act, miles, kcal});
      exActivity.value=''; exMiles.value=''; exCals.value='';
      saveAll(); refresh();
    };

    // Auto maintenance estimate (12 √ó current lbs)
    autoMaint.onclick = ()=>{
      const nonSummary = weights.filter(w=>!w._summary);
      const current = nonSummary.length ? parseFloat(nonSummary[nonSummary.length-1].weight) : NaN;
      if(isNaN(current)) return alert('Add a weight entry first.');
      maintKcal.value = Math.round(current * 12);
      saveAll(); refresh();
    };

    // Tables: edit/delete (delegation)
    logTBody.addEventListener('click',(e)=>{
      const tr = e.target.closest('tr'); if(!tr) return;
      const idx = +tr.dataset.index;
      if(e.target.classList.contains('editW')){
        const row = weights[idx];
        editingWeightIndex = idx;
        dateEl.value = row.date; weightEl.value = row.weight; notesEl.value = row.notes||'';
        addWeightBtn.classList.add('hide'); saveWeightBtn.classList.remove('hide');
      } else if(e.target.classList.contains('delW')){
        if(confirm('Delete this entry?')){ weights.splice(idx,1); saveAll(); refresh(); }
      }
    });
    foodTBody.addEventListener('click',(e)=>{
      const tr = e.target.closest('tr'); if(!tr) return;
      const idx = +tr.dataset.index;
      if(e.target.classList.contains('editF')){
        const row = foods[idx];
        foodDate.value = row.date; foodName.value = row.name||''; foodCals.value = row.kcal||'';
        foods.splice(idx,1); // load to form; remove old
        saveAll(); refresh();
      } else if(e.target.classList.contains('delF')){
        if(confirm('Delete this item?')){ foods.splice(idx,1); saveAll(); refresh(); }
      }
    });
    waterTBody.addEventListener('click',(e)=>{
      const tr = e.target.closest('tr'); if(!tr) return;
      const idx = +tr.dataset.index;
      if(e.target.classList.contains('editH')){
        const row = waters[idx];
        quickWater.value = row.cups;
        waters.splice(idx,1);
        saveAll(); refresh();
      } else if(e.target.classList.contains('delH')){
        if(confirm('Delete this water entry?')){ waters.splice(idx,1); saveAll(); refresh(); }
      }
    });
    exTBody.addEventListener('click',(e)=>{
      const tr = e.target.closest('tr'); if(!tr) return;
      const idx = +tr.dataset.index;
      if(e.target.classList.contains('editX')){
        const row = exercises[idx];
        exDate.value = row.date; exActivity.value = row.activity||''; exMiles.value = row.miles||''; exCals.value = row.kcal||'';
        exercises.splice(idx,1);
        saveAll(); refresh();
      } else if(e.target.classList.contains('delX')){
        if(confirm('Delete this exercise?')){ exercises.splice(idx,1); saveAll(); refresh(); }
      }
    });

    // Export/Import CSV (includes all types)
    exportCsvBtn.onclick = ()=>{
      const rows = [['type','date','value1','value2','value3']];
      weights.forEach(e=> rows.push(['weight', e.date, e.weight, e.notes||'', e._summary?'summary':'']));
      foods.forEach(f  => rows.push(['food',   f.date, f.name||'', f.kcal||0, '']));
      waters.forEach(h => rows.push(['water',  h.date, h.cups||0, '', '' ]));
      exercises.forEach(x=> rows.push(['exercise', x.date, x.activity||'', x.miles||0, x.kcal||0]));

      const csv = rows.map(r =>
        r.map(x => String(x).includes(',') ? `"${String(x).replace(/"/g,'""')}"` : x).join(',')
      ).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'weight360_export.csv';
      a.click(); URL.revokeObjectURL(url);
    };
    importCsv.addEventListener('change', ev=>{
      const file = ev.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        const lines = e.target.result.split(/\r?\n/).filter(Boolean);
        for(let i=1;i<lines.length;i++){
          const cols = parseCSVLine(lines[i]);
          const type = (cols[0]||'').toLowerCase();
          if(type==='weight'){
            const [_,d,w,notes,flag] = cols; const num = parseFloat(w);
            if(d && !isNaN(num)) weights.push({date:d, weight:num, notes:notes||'', _summary: flag==='summary'});
          } else if(type==='food'){
            const [_,d,name,kcal] = cols; const num = parseFloat(kcal);
            if(d && !isNaN(num)) foods.push({date:d, name:name||'', kcal:num});
          } else if(type==='water'){
            const [_,d,cups] = cols; const num = parseFloat(cups);
            if(d && !isNaN(num)) waters.push({date:d, cups:num});
          } else if(type==='exercise'){
            const [_,d,act,miles,kcal] = cols; const m = parseFloat(miles)||0; const k = parseFloat(kcal)||0;
            if(d) exercises.push({date:d, activity:act||'', miles:m, kcal:k});
          }
        }
        weights.sort((a,b)=> new Date(a.date)-new Date(b.date));
        foods.sort((a,b)=> new Date(a.date)-new Date(b.date));
        waters.sort((a,b)=> new Date(a.date)-new Date(b.date));
        exercises.sort((a,b)=> new Date(a.date)-new Date(b.date));
        saveAll(); refresh(); importCsv.value='';
      };
      reader.readAsText(file);
    });
    function parseCSVLine(line){
      const out=[]; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const c=line[i];
        if(c=='"'){ if(inQ && line[i+1]=='"'){ cur+='"'; i++; } else { inQ=!inQ; } }
        else if(c==',' && !inQ){ out.push(cur); cur=''; }
        else cur+=c;
      }
      out.push(cur); return out;
    }

    // Clear ALL data
    clearAllBtn.onclick = ()=>{
      const ans = prompt('Are you sure? Type "yes" to clear ALL data and start over.');
      if(ans && ans.toLowerCase()==='yes'){
        weights=[]; foods=[]; waters=[]; exercises=[];
        localStorage.removeItem(KEY_W);
        localStorage.removeItem(KEY_F);
        localStorage.removeItem(KEY_H);
        localStorage.removeItem(KEY_X);
        localStorage.removeItem(KEY_META); // remove this line if you want to keep name/goal
        refresh();
      }
    };

    // Goal save/clear
    saveGoalBtn.onclick = ()=>{ saveAll(); refresh(); };
    clearGoalBtn.onclick = ()=>{ goalEl.value=''; saveAll(); refresh(); };

    // Recompute summaries when date inputs change
    foodDate.onchange = ()=> updateFoodExerciseTotals();
    exDate.onchange = ()=> updateFoodExerciseTotals();

    // Core refresh pieces
    function renderGoalAndChartAndProgress(){ renderGoalAndProgress(); }
    function postRender(){ renderSummaryChips(); }

    // Tie into refresh
    const _oldRefresh = refresh;
    refresh = function(){
      renderWeights();
      renderFoods();
      renderWater();
      renderExercise();
      renderGoalAndProgress();
      renderSummaryChips();
    }
  </script>
</body>
</html>
